---
import "../styles/index.css";
import { getSpaceBySlug, type Space } from "../db/spaces.ts";
import Sidebar from "../components/Sidebar.vue";
import BottomNav from "../components/BottomNav.vue";
import CommandPalatte from "../components/CommandPalatte.vue";
import { generatePaletteCss } from "../utils/utils.ts";
import Translations from "../components/Translations.vue";
import ImportFiles from "../components/ImportFiles.vue";
import LinkPreview from "../components/LinkPreview.vue";
import DocumentOverlay from "../components/DocumentOverlay.vue";
import SeoMeta from "../layouts/SeoMeta.astro";
import { ClientRouter } from "astro:transitions";

export interface Props {
  title?: string;
  meta?: {
    title?: string;
    description?: string;
    image?: string;
    url?: string;
  };
}

const { title = "Wiki", meta } = Astro.props;
const lang = Astro.preferredLocale || "en";

const pathname = Astro.url.pathname;
const pathParts = pathname.split("/").filter(Boolean);
const currentSpaceSlug = pathParts[0] || "";

let currentSpace: Space | null = null;
let brandColor = "#1e293b"; // Default dark color

if (Astro.locals.user) {
  if (currentSpaceSlug) {
    currentSpace = await getSpaceBySlug(currentSpaceSlug);
    if (currentSpace) {
      brandColor = currentSpace.preferences?.brandColor || "#1e293b";
    }
  }
}

// Generate color palette from brand color
const paletteCss = generatePaletteCss(brandColor);
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>{title}</title>

    <SeoMeta meta={meta} />

    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="manifest" href="/manifest.json" />

    <meta
      name="theme-color"
      content="#ffffff"
      media="(prefers-color-scheme: light)" />
    <meta
      name="theme-color"
      content="#181818"
      media="(prefers-color-scheme: dark)" />

    <ClientRouter />

    <script>
      import "../utils/elements.js";

      navigator.serviceWorker.register("/sw.js").then(
        (registration) => {
          console.log("Service worker registration succeeded:", registration);
        },
        (error) => {
          console.error(`Service worker registration failed: ${error}`);
        },
      );
    </script>

    <script>
      import { history } from "../utils/history.ts";
      window.addEventListener('load', () => {
        history.log(location.pathname, document.title);
      })
      window.addEventListener('astro:page-load', () => {
        history.log(location.pathname, document.title);
      })
    </script>

    <script>
      import { Actions } from "../utils/actions.js";
      import shortcuts from "../config/shortcuts.json";

      for (const [shortcut, action] of Object.entries(shortcuts)) {
        Actions.mapShortcut(shortcut, action);
      }
    </script>

    <script>
      import { extensions } from "../utils/extensions.ts";

      // Initialise extensions for the current space
      const spaceId = document.body.dataset.spaceId;
      if (spaceId) {
        extensions.init(spaceId).catch((err) => {
          console.error("Failed to initialise extensions:", err);
        });
      }

      // Re-init on page navigation (Astro transitions)
      document.addEventListener("astro:page-load", () => {
        const newSpaceId = document.body.dataset.spaceId;
        if (newSpaceId) {
          extensions.init(newSpaceId).catch((err) => {
            console.error("Failed to initialise extensions:", err);
          });
        }
      });
    </script>

    <style set:html={`
      :root {
        --color-primary: ${brandColor};
        ${paletteCss.light}
      }
      @media (prefers-color-scheme: dark) {
        :root body {
          --color-primary: ${brandColor};
          ${paletteCss.dark}
        }
      }
    `}></style>

    <Translations client:load lang={lang} />
  </head>

  <body class="bg-background font-sans" data-space-id={currentSpace?.id ?? ""}>

    <div id="root" class="mx-auto relative origin-top">
      <script>
        if(typeof window !== "undefined") {
          const savedWidth = localStorage.getItem("sidebar-width");
          document.body.style.setProperty(
            "--sidebar-width",
            `${savedWidth}px`,
          );
        }
      </script>

      <!-- Fixed Sidebar -->
      <Sidebar client:load transition:name="navigation" />

      <!-- Main Content Area with left margin for fixed sidebar -->
      <div transition:name="content" transition:animate="none" class="main-content min-h-screen h-full transition-all lg:transition-none lg:pl-(--sidebar-width) flex">
        <!-- Content -->
        <div class="w-full max-w-(--site-width) mx-auto">
          <slot />
        </div>
      </div>
    </div>

    <CommandPalatte client:only />

    <ImportFiles client:only />

    <!-- <LinkPreview client:only /> -->

    <DocumentOverlay client:only="vue" />

    <!-- Bottom Navigation -->
    <BottomNav
        client:load
        transition:name="navigation"
        spaceSlug={currentSpaceSlug}
        pathname={pathname}
    />

    <slot name="outer"></slot>
  </body>
</html>
