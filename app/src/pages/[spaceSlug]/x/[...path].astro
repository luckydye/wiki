---
import ExtensionView from "../../../components/ExtensionView.vue";
import { hasPermission, ResourceType, getUserGroups } from "../../../db/acl.ts";
import { findExtensionForRoute } from "../../../db/extensions.ts";
import { getSpaceBySlug } from "../../../db/spaces.ts";
import SpaceLayout from "../../../layouts/SpaceLayout.astro";

if (!Astro.locals.session) {
  return Astro.redirect("/login");
}

const { spaceSlug, path } = Astro.params;

if (!spaceSlug || !path) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

const space = await getSpaceBySlug(spaceSlug);

if (!space) {
  return new Response(null, {
    status: 404,
    statusText: "Space not found",
  });
}

// Check ACL permissions - user must be a member of the space
const userGroups = await getUserGroups(Astro.locals.user!.id);
const hasAccess = await hasPermission(
  space.id,
  ResourceType.SPACE,
  space.id,
  Astro.locals.user!.id,
  "viewer",
  userGroups,
);

if (!hasAccess) {
  return new Response(null, {
    status: 403,
    statusText: "Forbidden",
  });
}

// Find extension that handles this route
const match = await findExtensionForRoute(space.id, path);

if (!match) {
  return new Response(null, {
    status: 404,
    statusText: "Extension route not found",
  });
}

const pageTitle = match.route.title || match.extension.manifest.name;
---

<SpaceLayout title={`${pageTitle} - ${space.name} - Wiki`}>
  <div class="mx-auto pt-m pb-20 lg:pb-8 overflow-hidden h-full print:px-0 px-xs lg:px-xl relative">
    <ExtensionView
      client:only
      extensionId={match.extension.id}
      routePath={path}
      spaceId={space.id}
    />
  </div>
</SpaceLayout>
